{% extends "base.html" %}

{% block title %}Reset Password - ResearchHub Pro{% endblock %}

{% block content %}
<div class="auth-layout" aria-labelledby="resetHeading">
    <div class="auth-panel" role="form">
        <div class="logo-mark" aria-hidden="true"><i class="fas fa-shield-halved"></i></div>
        <div class="text-center">
            <span class="section-label">Secure access</span>
            <h1 id="resetHeading">Create a new password</h1>
            <p class="mb-0">Choose a strong password to protect your research workspace.</p>
        </div>
        {% if not token %}
        <div class="surface-subtle text-center" role="alert">
            <p class="mb-2 text-muted">This reset link is missing a token or has already been used.</p>
            <a href="/forgot-password" class="btn btn-primary">Request a new link</a>
        </div>
        {% else %}
        <form id="resetPasswordForm" class="d-grid gap-3" novalidate>
            <input type="hidden" id="resetToken" value="{{ token }}">
            <div>
                <label for="newPassword" class="form-label">New password</label>
                <div class="input-append">
                    <input type="password" class="form-control" id="newPassword" autocomplete="new-password" minlength="8" required aria-required="true">
                    <button type="button" class="input-action" id="resetPasswordToggle" aria-label="Toggle password visibility">
                        <i class="fas fa-eye"></i>
                    </button>
                </div>
                <div class="form-text">Use at least 8 characters including letters, numbers, and symbols.</div>
            </div>
            <div>
                <label for="confirmResetPassword" class="form-label">Confirm password</label>
                <input type="password" class="form-control" id="confirmResetPassword" autocomplete="new-password" required aria-required="true">
            </div>
            <button type="submit" class="btn btn-primary w-100" id="resetSubmitBtn">
                <span class="default-label"><i class="fas fa-lock-open me-1"></i> Update password</span>
                <span class="spinner-label d-none"><i class="fas fa-spinner fa-spin me-2"></i> Updatingâ€¦</span>
            </button>
        </form>
        <div class="auth-links">
            <span><a href="/login">Back to sign in</a></span>
            <span><a href="/forgot-password">Request another link</a></span>
        </div>
        {% endif %}
    </div>
</div>
{% endblock %}

{% block extra_js %}
{% if token %}
<script>
(function() {
    const form = document.getElementById('resetPasswordForm');
    const submitBtn = document.getElementById('resetSubmitBtn');
    const passwordField = document.getElementById('newPassword');
    const confirmField = document.getElementById('confirmResetPassword');
    const passwordToggle = document.getElementById('resetPasswordToggle');

    function setSubmitting(submitting) {
        submitBtn.disabled = submitting;
        submitBtn.querySelector('.default-label').classList.toggle('d-none', submitting);
        submitBtn.querySelector('.spinner-label').classList.toggle('d-none', !submitting);
    }

    if (passwordToggle) {
        passwordToggle.addEventListener('click', () => {
            const isPassword = passwordField.getAttribute('type') === 'password';
            passwordField.setAttribute('type', isPassword ? 'text' : 'password');
            passwordToggle.innerHTML = isPassword ? '<i class="fas fa-eye-slash"></i>' : '<i class="fas fa-eye"></i>';
        });
    }

    form.addEventListener('submit', async (event) => {
        event.preventDefault();

        if (!form.checkValidity()) {
            form.classList.add('was-validated');
            return;
        }

        const password = passwordField.value;
        const confirmPassword = confirmField.value;

        if (password !== confirmPassword) {
            showAlert('Passwords do not match.', 'warning');
            confirmField.focus();
            return;
        }

        try {
            setSubmitting(true);
            await resetPasswordWithToken({
                token: document.getElementById('resetToken').value,
                password,
                confirmPassword
            });
            setTimeout(() => {
                window.location.href = '/login';
            }, 1200);
        } catch (error) {
            console.warn('Reset password error:', error);
        } finally {
            setSubmitting(false);
        }
    });
})();
</script>
{% endif %}
{% endblock %}
