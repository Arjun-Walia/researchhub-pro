{% extends "base.html" %}

{% block title %}Collections - ResearchHub Pro{% endblock %}

{% block content %}
<div class="page-header">
    <div class="page-title">
        <span class="section-label">Collections</span>
        <h1>Curated research intelligence</h1>
        <p class="page-subtitle">Group results into reusable briefs, power executive updates, and keep your organisation aligned.</p>
    </div>
    <div class="d-flex flex-wrap gap-2 align-items-center">
        <button class="btn btn-secondary" type="button" onclick="loadCollections()"><i class="fas fa-rotate"></i> Refresh</button>
        <button class="btn btn-primary" type="button" data-bs-toggle="modal" data-bs-target="#createCollectionModal">
            <i class="fas fa-plus"></i> New collection
        </button>
    </div>
</div>

<div id="collectionsLoading" class="empty-state fade-up">
    <div class="empty-illustration">
        <div class="dot-spinner dot-spinner--lg" aria-hidden="true">
            <div class="dot-spinner__dot"></div>
            <div class="dot-spinner__dot"></div>
            <div class="dot-spinner__dot"></div>
            <div class="dot-spinner__dot"></div>
            <div class="dot-spinner__dot"></div>
            <div class="dot-spinner__dot"></div>
            <div class="dot-spinner__dot"></div>
            <div class="dot-spinner__dot"></div>
        </div>
    </div>
    <p class="mb-0 text-muted">Gathering your curated research collections...</p>
</div>

<div id="collectionsEmpty" class="empty-state fade-up d-none">
    <div class="empty-illustration"><i class="fas fa-books"></i></div>
    <h4 class="mb-2">No collections yet</h4>
    <p class="mb-3 text-muted">Capture searches into themed collections to collaborate with teammates.</p>
    <button class="btn btn-primary" type="button" data-bs-toggle="modal" data-bs-target="#createCollectionModal">
        <i class="fas fa-plus"></i> Create collection
    </button>
</div>

<div id="collectionBulkActions" class="surface-subtle d-none justify-content-between align-items-center mb-4">
    <div>
        <strong id="bulkSelectedCount">0 selected</strong>
        <p class="mb-0 text-muted">Export, share, or move the selected collections without leaving the page.</p>
    </div>
    <div class="action-group">
        <button class="btn btn-secondary" type="button" onclick="bulkShareCollections()"><i class="fas fa-share-nodes"></i> Share</button>
        <button class="btn btn-primary" type="button" onclick="bulkExportCollections()"><i class="fas fa-file-export"></i> Export</button>
    </div>
</div>

<div id="recentCollections" class="surface-card mb-4 d-none"></div>

<div id="collectionsGrid" class="collection-grid d-none"></div>

<!-- Create Collection Modal -->
<div class="modal fade" id="createCollectionModal" tabindex="-1">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Create a collection</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="createCollectionForm" class="d-grid gap-3">
                    <div>
                        <label for="collectionName" class="form-label">Collection name</label>
                        <input type="text" class="form-control" id="collectionName" placeholder="e.g., EV market entrants" required>
                    </div>
                    <div>
                        <label for="collectionDescription" class="form-label">Description</label>
                        <textarea class="form-control" id="collectionDescription" rows="3" placeholder="What insights live here?"></textarea>
                    </div>
                    <div class="form-check">
                        <input class="form-check-input" type="checkbox" id="collectionPublic">
                        <label class="form-check-label" for="collectionPublic">Allow workspace members to view</label>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-ghost" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" onclick="handleCreateCollectionSubmit()">Create collection</button>
            </div>
        </div>
    </div>
</div>

        <div class="modal fade" id="collectionDetailModal" tabindex="-1" aria-labelledby="collectionDetailTitle" aria-hidden="true">
            <div class="modal-dialog modal-dialog-scrollable modal-lg">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title" id="collectionDetailTitle">
                            <span class="ui-bookmark ui-bookmark--inline ui-bookmark--static me-2" aria-hidden="true">
                                <input type="checkbox" checked>
                                <span class="bookmark">
                                    <svg viewBox="0 0 32 32" aria-hidden="true" focusable="false">
                                        <path d="M27 4v27a1 1 0 0 1-1.625.781L16 24.281l-9.375 7.5A1 1 0 0 1 5 31V4a4 4 0 0 1 4-4h14a4 4 0 0 1 4 4z"></path>
                                    </svg>
                                </span>
                            </span>
                            Collection overview
                        </h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                    </div>
                    <div class="modal-body">
                        <div id="collectionDetailMeta" class="mb-3 text-muted small"></div>
                        <div id="collectionDetailBody">
                            <div class="text-center py-4">
                                <div class="dot-spinner dot-spinner--lg dot-spinner--neutral mx-auto" aria-hidden="true">
                                    <div class="dot-spinner__dot"></div>
                                    <div class="dot-spinner__dot"></div>
                                    <div class="dot-spinner__dot"></div>
                                    <div class="dot-spinner__dot"></div>
                                    <div class="dot-spinner__dot"></div>
                                    <div class="dot-spinner__dot"></div>
                                    <div class="dot-spinner__dot"></div>
                                    <div class="dot-spinner__dot"></div>
                                </div>
                                <p class="text-muted mt-3 mb-0">Loading collection…</p>
                            </div>
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-ghost" data-bs-dismiss="modal">Close</button>
                    </div>
                </div>
            </div>
        </div>

<script>
let collectionsData = [];
const selectedCollections = new Set();
let collectionsRelativeTimeTimer = null;
const collectionDetailModalEl = document.getElementById('collectionDetailModal');
const collectionDetailTitle = document.getElementById('collectionDetailTitle');
const collectionDetailMeta = document.getElementById('collectionDetailMeta');
const collectionDetailBody = document.getElementById('collectionDetailBody');
const collectionDetailState = { collectionId: null };
const collectionDetailModal = collectionDetailModalEl && window.bootstrap
    ? bootstrap.Modal.getOrCreateInstance(collectionDetailModalEl)
    : null;
const refreshIcons = (root) => {
    if (typeof window.refreshIconAccessibility === 'function') {
        window.refreshIconAccessibility(root || document);
    }
};

document.addEventListener('DOMContentLoaded', function() {
    const token = localStorage.getItem('access_token');
    if (!token) {
        const loading = document.getElementById('collectionsLoading');
        const empty = document.getElementById('collectionsEmpty');
        loading.classList.add('d-none');
        empty.classList.remove('d-none');
        empty.innerHTML = `
            <div class="empty-illustration"><i class="fas fa-user-lock"></i></div>
            <h4 class="mb-2">Sign in required</h4>
            <p class="mb-3 text-muted">Authenticate to organise research into collections.</p>
            <a href="/login" class="btn btn-primary">Sign in</a>
        `;
        refreshIcons(empty);
        return;
    }

    loadCollections();
    refreshIcons(document);
});

async function loadCollections() {
    const loading = document.getElementById('collectionsLoading');
    const grid = document.getElementById('collectionsGrid');
    const empty = document.getElementById('collectionsEmpty');
    const recent = document.getElementById('recentCollections');

    loading.classList.remove('d-none');
    grid.classList.add('d-none');
    empty.classList.add('d-none');
    recent.classList.add('d-none');

    selectedCollections.clear();
    updateBulkActions();

    try {
        const response = await api.get('/collections');
        collectionsData = response.collections || [];

        loading.classList.add('d-none');

        if (!collectionsData.length) {
            empty.classList.remove('d-none');
            refreshIcons(empty);
            renderRecentCollections();
            stopCollectionsRelativeTimeTicker();
            return;
        }

        grid.classList.remove('d-none');
        displayCollections();
        renderRecentCollections();
        startCollectionsRelativeTimeTicker();
    } catch (error) {
        console.error('Failed to load collections:', error);
        loading.classList.add('d-none');
        empty.classList.remove('d-none');
        const isApiError = typeof ApiError !== 'undefined' && error instanceof ApiError;
        const message = isApiError ? error.message : ('Failed to load collections: ' + (error?.message || 'Unknown error'));
        showAlert(message, 'error');
        refreshIcons(empty);
        stopCollectionsRelativeTimeTicker();
    }
}

function renderRecentCollections() {
    const recent = document.getElementById('recentCollections');
    if (!recent) return;

    const latest = [...collectionsData]
        .sort((a, b) => new Date(b.updated_at || b.created_at || 0) - new Date(a.updated_at || a.created_at || 0))
        .slice(0, 3);

    if (!latest.length) {
        recent.classList.add('d-none');
        return;
    }

    recent.classList.remove('d-none');
    recent.innerHTML = `
        <div class="d-flex justify-content-between align-items-center mb-3">
            <div>
                <span class="section-label">Recent additions</span>
                <h4 class="mb-0">Latest curated intelligence</h4>
            </div>
            <span class="badge badge-neutral">Updated automatically</span>
        </div>
        <div class="d-grid gap-2">
            ${latest.map(collection => {
                const rawTimestamp = collection.updated_at || collection.created_at;
                let normalizedTimestamp = new Date().toISOString();
                if (rawTimestamp) {
                    const parsed = new Date(rawTimestamp);
                    if (!Number.isNaN(parsed.getTime())) {
                        normalizedTimestamp = parsed.toISOString();
                    }
                }
                const relativeLabel = formatRelativeTime(normalizedTimestamp);
                return `
                    <div class="surface-subtle d-flex justify-content-between align-items-center">
                        <div>
                            <strong>${escapeHtml(collection.title)}</strong>
                            <p class="mb-0 text-muted">${escapeHtml(collection.description || 'No description provided')}</p>
                        </div>
                        <span class="text-muted"><i class="fas fa-clock"></i> <span class="relative-time" data-timestamp="${normalizedTimestamp}">${relativeLabel}</span></span>
                    </div>
                `;
            }).join('')}
        </div>
    `;
    refreshIcons(recent);
    refreshCollectionRelativeTimes();
}

function displayCollections() {
    const grid = document.getElementById('collectionsGrid');
    if (!grid) return;

    grid.innerHTML = collectionsData.map(collection => {
        let tags = [];
        if (Array.isArray(collection.tags)) {
            tags = collection.tags.filter(Boolean);
        } else if (typeof collection.tags === 'string') {
            tags = collection.tags.split(',').map(tag => tag.trim()).filter(Boolean);
        }
        const ownerLabel = typeof collection.owner === 'string'
            ? collection.owner
            : (collection.owner && collection.owner.name ? collection.owner.name : 'You');
        const rawTimestamp = collection.updated_at || collection.created_at;
        let normalizedTimestamp = new Date().toISOString();
        if (rawTimestamp) {
            const parsed = new Date(rawTimestamp);
            if (!Number.isNaN(parsed.getTime())) {
                normalizedTimestamp = parsed.toISOString();
            }
        }
        const updatedLabel = formatRelativeTime(normalizedTimestamp);
        const resultCount = Number(collection.result_count) || 0;
        return `
            <div class="surface-card collection-card" data-collection-id="${collection.id}">
                <div class="d-flex justify-content-between align-items-start mb-2">
                    <div class="form-check">
                        <input class="form-check-input" type="checkbox" value="${collection.id}" onchange="toggleCollectionSelection(${collection.id}, this.checked)">
                    </div>
                    <span class="badge ${collection.is_public ? 'badge-positive' : 'badge-neutral'}">${collection.is_public ? 'Shared' : 'Private'}</span>
                </div>
                <div class="card-header-inline">
                    <div>
                        <h4 class="mb-1">${escapeHtml(collection.title)}</h4>
                        <p class="mb-0 text-muted">${escapeHtml(collection.description || 'A ready-to-share research packet.')}</p>
                    </div>
                    <div class="action-group">
                        <button class="btn-icon" type="button" onclick="shareCollection(${collection.id})" title="Share collection">
                            <i class="fas fa-share-nodes"></i>
                        </button>
                        <button class="btn-icon" type="button" onclick="exportCollection(${collection.id})" title="Export collection">
                            <i class="fas fa-file-export"></i>
                        </button>
                    </div>
                </div>
                <div class="surface-subtle mb-3">
                    <div class="d-flex flex-wrap gap-3">
                        <span class="text-muted"><i class="fas fa-file-alt"></i> ${resultCount.toLocaleString()} documents</span>
                        <span class="text-muted"><i class="fas fa-user"></i> Owner: ${escapeHtml(ownerLabel || 'You')}</span>
                        <span class="text-muted"><i class="fas fa-clock"></i> Updated <span class="relative-time" data-timestamp="${normalizedTimestamp}">${updatedLabel}</span></span>
                    </div>
                </div>
                ${tags.length ? `<div class="chip-group mb-3">${tags.map(tag => `<span class="chip">${escapeHtml(tag)}</span>`).join('')}</div>` : ''}
                <div class="card-actions">
                    <div class="action-group">
                        <button class="btn btn-secondary btn-sm" type="button" onclick="viewCollection(${collection.id})">
                            <i class="fas fa-eye"></i> Open
                        </button>
                        <button class="btn btn-secondary btn-sm" type="button" onclick="duplicateCollection(${collection.id})">
                            <i class="fas fa-clone"></i> Duplicate
                        </button>
                    </div>
                    <button class="btn-icon" type="button" onclick="deleteCollection(${collection.id})" title="Delete collection">
                        <i class="fas fa-trash"></i>
                    </button>
                </div>
            </div>
        `;
    }).join('');
    refreshIcons(grid);
    if (typeof window.enhanceCheckboxes === 'function') {
        window.enhanceCheckboxes(grid);
    }
}

function refreshCollectionRelativeTimes() {
    document.querySelectorAll('.relative-time[data-timestamp]').forEach(element => {
        const timestamp = element.getAttribute('data-timestamp');
        if (!timestamp) {
            return;
        }

        try {
            element.textContent = formatRelativeTime(timestamp);
        } catch (error) {
            console.warn('Failed to refresh collection relative time for', timestamp, error);
        }
    });
}

function startCollectionsRelativeTimeTicker() {
    refreshCollectionRelativeTimes();
    if (collectionsRelativeTimeTimer) {
        clearInterval(collectionsRelativeTimeTimer);
    }
    collectionsRelativeTimeTimer = setInterval(refreshCollectionRelativeTimes, 30000);
}

function stopCollectionsRelativeTimeTicker() {
    if (collectionsRelativeTimeTimer) {
        clearInterval(collectionsRelativeTimeTimer);
        collectionsRelativeTimeTimer = null;
    }
}

function toggleCollectionSelection(id, isChecked) {
    const normalizedId = Number(id);
    if (isChecked) {
        selectedCollections.add(normalizedId);
    } else {
        selectedCollections.delete(normalizedId);
    }
    updateBulkActions();
}

function updateBulkActions() {
    const bulkBar = document.getElementById('collectionBulkActions');
    const countLabel = document.getElementById('bulkSelectedCount');
    if (!bulkBar || !countLabel) return;

    const count = selectedCollections.size;
    countLabel.textContent = `${count} selected`;

    if (count > 0) {
        bulkBar.classList.remove('d-none');
        bulkBar.classList.add('d-flex');
    } else {
        bulkBar.classList.add('d-none');
        bulkBar.classList.remove('d-flex');
    }
}

async function handleCreateCollectionSubmit() {
    const name = document.getElementById('collectionName').value.trim();
    const description = document.getElementById('collectionDescription').value.trim();
    const isPublic = document.getElementById('collectionPublic').checked;

    if (!name) {
        showAlert('Please enter a collection name', 'warning');
        return;
    }

    try {
    await api.post('/collections', { title: name, description, is_public: isPublic });
        showAlert('Collection created successfully!', 'success');
        const modal = bootstrap.Modal.getOrCreateInstance(document.getElementById('createCollectionModal'));
        if (modal) {
            modal.hide();
        }
        document.getElementById('createCollectionForm').reset();
        await loadCollections();
    } catch (error) {
        console.error('Failed to create collection:', error);
        showAlert('Failed to create collection: ' + error.message, 'error');
    }
}

function viewCollection(collectionId) {
    openCollectionDetail(collectionId);
}








function renderCollectionResultItem(collectionId, result) {
    const title = escapeHtml(result.title || 'Untitled result');
    const snippetSource = result.snippet || result.summary || '';
    const snippet = snippetSource ? escapeHtml(snippetSource.slice(0, 240)) : '';
    const url = escapeHtml(result.url || '#');
    const rawId = result.id;
    const numericId = Number(rawId);
    const canRemove = Number.isFinite(numericId) && numericId > 0;
    const removeId = canRemove ? numericId : null;
    let normalizedPublished = '';
    if (result.published_date) {
        const parsed = new Date(result.published_date);
        if (!Number.isNaN(parsed.getTime())) {
            normalizedPublished = parsed.toISOString();
        }
    }
    const publishedDisplay = normalizedPublished ? new Date(normalizedPublished).toLocaleDateString() : null;
    const relativeDisplay = normalizedPublished ? formatRelativeTime(normalizedPublished) : null;
    const idLabel = rawId ?? (canRemove ? removeId : 'N/A');

    return `
        <div class="surface-subtle rounded p-3">
            <div class="d-flex justify-content-between align-items-start gap-2">
                <a href="${url}" target="_blank" rel="noopener" class="fw-semibold">${title}</a>
                ${canRemove ? `<button class="btn-icon" type="button" onclick="removeResultFromCollection(${collectionId}, ${removeId})" title="Remove from collection">
                    <i class="fas fa-xmark"></i>
                </button>` : ''}
            </div>
            ${snippet ? `<p class="mb-2 text-muted small">${snippet}${snippetSource.length > 240 ? '…' : ''}</p>` : ''}
            <div class="text-muted small d-flex flex-wrap gap-3">
                ${publishedDisplay ? `<span><i class="fas fa-calendar-day me-1"></i>${publishedDisplay}</span>` : ''}
                ${relativeDisplay ? `<span><i class="fas fa-clock me-1"></i><span class="relative-time" data-timestamp="${normalizedPublished}">${relativeDisplay}</span></span>` : ''}
                <span><i class="fas fa-hashtag me-1"></i>ID ${escapeHtml(String(idLabel))}</span>
            </div>
        </div>
    `;
}

async function renderCollectionDetail(collectionId) {
    if (!collectionDetailBody) {
        return;
    }

    collectionDetailBody.innerHTML = `
        <div class="text-center py-4" role="status" aria-live="polite" aria-busy="true" aria-describedby="collectionDetailLoadingText">
            <div class="dot-spinner dot-spinner--lg dot-spinner--neutral mx-auto" aria-hidden="true">
                <span class="dot-spinner__dot"></span>
                <span class="dot-spinner__dot"></span>
                <span class="dot-spinner__dot"></span>
                <span class="dot-spinner__dot"></span>
                <span class="dot-spinner__dot"></span>
                <span class="dot-spinner__dot"></span>
                <span class="dot-spinner__dot"></span>
                <span class="dot-spinner__dot"></span>
            </div>
            <p id="collectionDetailLoadingText" class="text-muted mt-3 mb-0">Loading collection…</p>
        </div>
    `;
    if (collectionDetailMeta) {
        collectionDetailMeta.innerHTML = '';
    }

    try {
        const response = await api.get(`/collections/${collectionId}`);
        const collection = response.collection;
        const results = response.results || [];

        if (collectionDetailTitle) {
            collectionDetailTitle.innerHTML = `
                <span class="ui-bookmark ui-bookmark--inline ui-bookmark--static me-2" aria-hidden="true">
                    <input type="checkbox" checked>
                    <span class="bookmark">
                        <svg viewBox="0 0 32 32" aria-hidden="true" focusable="false">
                            <path d="M27 4v27a1 1 0 0 1-1.625.781L16 24.281l-9.375 7.5A1 1 0 0 1 5 31V4a4 4 0 0 1 4-4h14a4 4 0 0 1 4 4z"></path>
                        </svg>
                    </span>
                </span>
                ${escapeHtml(collection.title || 'Collection')}
            `.trim();
        }

        const docCount = Number(collection.result_count || results.length) || 0;
        const rawTimestamp = collection.updated_at || collection.created_at;
        let normalizedTimestamp = new Date().toISOString();
        if (rawTimestamp) {
            const parsed = new Date(rawTimestamp);
            if (!Number.isNaN(parsed.getTime())) {
                normalizedTimestamp = parsed.toISOString();
            }
        }

        if (collectionDetailMeta) {
            collectionDetailMeta.innerHTML = `
                <div class="d-flex flex-wrap gap-3 text-muted small">
                    <span><i class="fas fa-file-alt me-1"></i>${docCount.toLocaleString()} documents</span>
                    <span><i class="fas fa-users me-1"></i>${collection.is_public ? 'Shared workspace access' : 'Private to you'}</span>
                    <span><i class="fas fa-clock me-1"></i>Updated <span class="relative-time" data-timestamp="${normalizedTimestamp}">${formatRelativeTime(normalizedTimestamp)}</span></span>
                </div>
            `;
        }

        if (!results.length) {
            collectionDetailBody.innerHTML = `
                <div class="empty-state py-5">
                    <div class="empty-illustration"><i class="fas fa-book-open"></i></div>
                    <h5 class="mb-2">No saved results yet</h5>
                    <p class="mb-0 text-muted">Add sources from the search page to populate this collection.</p>
                </div>
            `;
        } else {
            collectionDetailBody.innerHTML = `
                <div class="d-grid gap-3">
                    ${results.map(result => renderCollectionResultItem(collectionId, result)).join('')}
                </div>
            `;
        }

        refreshIcons(collectionDetailBody);
        refreshCollectionRelativeTimes();
    } catch (error) {
        console.error('Failed to load collection detail:', error);
        const isApiError = typeof ApiError !== 'undefined' && error instanceof ApiError;
        const message = isApiError ? error.message : 'Unable to load collection details right now.';
        collectionDetailBody.innerHTML = `<div class="alert alert-danger mb-0" role="alert">${message}</div>`;
    }
}

async function openCollectionDetail(collectionId) {
    const normalizedId = Number(collectionId);
    if (!normalizedId || Number.isNaN(normalizedId)) {
        showAlert('Collection not found.', 'warning');
        return;
    }

    if (!collectionDetailModal) {
        showAlert('Collection details are unavailable right now.', 'error');
        return;
    }

    collectionDetailState.collectionId = normalizedId;
    collectionDetailModal.show();
    await renderCollectionDetail(normalizedId);
}

async function duplicateCollection(collectionId) {
    try {
        const response = await api.post(`/collections/${collectionId}/duplicate`, {});
        const duplicated = response?.collection;
        showAlert('Collection duplicated successfully!', 'success');
        await loadCollections();
        if (duplicated?.id) {
            collectionDetailState.collectionId = duplicated.id;
        }
    } catch (error) {
        console.error('Failed to duplicate collection:', error);
        const isApiError = typeof ApiError !== 'undefined' && error instanceof ApiError;
        const message = isApiError ? error.message : 'Failed to duplicate collection.';
        showAlert(message, 'error');
    }
}

function shareCollection(collectionId) {
    showAlert(`Generate secure share link for collection ${collectionId}.`, 'info');
}

function exportCollection(collectionId, format = 'json') {
    if (!collectionId) {
        showAlert('Select a collection to export.', 'warning');
        return;
    }

    if (format !== 'json') {
        showAlert('Only JSON export is available for collections right now.', 'info');
        format = 'json';
    }

    window.location.href = `/api/v1/collections/${collectionId}/export?format=${format}`;
}

function bulkExportCollections() {
    if (!selectedCollections.size) {
        showAlert('Select collections to export.', 'warning');
        return;
    }
    selectedCollections.forEach(id => exportCollection(id, 'json'));
}

function bulkShareCollections() {
    if (!selectedCollections.size) {
        showAlert('Select collections to share.', 'warning');
        return;
    }
    showAlert('Batch sharing workflow launching soon.', 'info');
}

async function removeResultFromCollection(collectionId, resultId) {
    if (!collectionId || !resultId) {
        return;
    }

    try {
        await api.delete(`/collections/${collectionId}/results/${resultId}`);
        showAlert('Result removed from collection.', 'success');
        await renderCollectionDetail(collectionId);
        await loadCollections();
    } catch (error) {
        console.error('Failed to remove result from collection:', error);
        const isApiError = typeof ApiError !== 'undefined' && error instanceof ApiError;
        const message = isApiError ? error.message : 'Unable to remove result from collection.';
        showAlert(message, 'error');
    }
}

async function deleteCollection(collectionId) {
    if (!confirm('Are you sure you want to delete this collection?')) {
        return;
    }

    try {
        await api.delete(`/collections/${collectionId}`);
        showAlert('Collection deleted successfully!', 'success');
        await loadCollections();
    } catch (error) {
        console.error('Failed to delete collection:', error);
        const isApiError = typeof ApiError !== 'undefined' && error instanceof ApiError;
        const message = isApiError ? error.message : 'Failed to delete collection. Please try again.';
        showAlert(message, 'error');
    }
}

if (collectionDetailModalEl) {
    collectionDetailModalEl.addEventListener('hidden.bs.modal', () => {
        collectionDetailState.collectionId = null;
        if (collectionDetailMeta) {
            collectionDetailMeta.innerHTML = '';
        }
        if (collectionDetailBody) {
            collectionDetailBody.innerHTML = '';
        }
    });
}

window.addEventListener('collections:updated', () => {
    if (!localStorage.getItem('access_token')) {
        return;
    }
    loadCollections().catch(error => console.error('Failed to refresh collections after update:', error));
});

function escapeHtml(value) {
    const div = document.createElement('div');
    div.textContent = value ?? '';
    return div.innerHTML;
}
</script>
{% endblock %}
